<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام كشف سرقة الكهرباء | AI-Powered Fraud Detection</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --primary-light: #60a5fa;
            --accent: #f59e0b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --critical: #dc2626;
            --bg-dark: #0a0f1a;
            --bg-card: #111827;
            --bg-card-hover: #1f2937;
            --border: #1f2937;
            --border-light: #374151;
            --text: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg-dark); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* Upload Modal */
        .upload-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.3s; }
        .upload-modal.hidden { opacity: 0; pointer-events: none; }
        .upload-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 48px; max-width: 600px; width: 90%; text-align: center; }
        .upload-icon { width: 100px; height: 100px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 24px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; font-size: 40px; color: white; }
        .upload-title { font-size: 2rem; font-weight: 800; margin-bottom: 8px; background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .upload-subtitle { font-size: 1rem; color: var(--text-secondary); margin-bottom: 32px; }
        .upload-zone { border: 2px dashed var(--border); border-radius: 16px; padding: 48px 24px; cursor: pointer; transition: all 0.3s; margin-bottom: 24px; }
        .upload-zone:hover { border-color: var(--primary); background: rgba(59,130,246,0.05); }
        .file-input { display: none; }
        .selected-file { display: none; padding: 16px; background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); border-radius: 12px; margin-bottom: 24px; color: var(--success); font-weight: 600; }
        .selected-file.show { display: block; }
        .btn-upload { padding: 16px 56px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border: none; border-radius: 12px; color: white; font-family: 'Cairo', sans-serif; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn-upload:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(59,130,246,0.3); }
        .btn-upload:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* Sidebar */
        .sidebar { width: 280px; background: var(--bg-card); border-left: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
        .logo { padding: 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 14px; }
        .logo-icon { width: 50px; height: 50px; background: linear-gradient(135deg, var(--danger), var(--accent)); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; }
        .logo-text h1 { font-size: 1.1rem; font-weight: 800; line-height: 1.3; }
        .logo-text span { font-size: 0.75rem; color: var(--text-muted); }
        .nav { padding: 16px 12px; flex: 1; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border-radius: 12px; cursor: pointer; transition: all 0.2s; margin-bottom: 6px; color: var(--text-secondary); }
        .nav-item:hover { background: var(--bg-card-hover); color: var(--text); }
        .nav-item.active { background: rgba(59,130,246,0.15); color: var(--primary); }
        .nav-item i { width: 22px; font-size: 1.1rem; }

        /* Main */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 20px 32px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .page-title h2 { font-size: 1.6rem; font-weight: 700; }
        .page-title span { font-size: 0.9rem; color: var(--text-secondary); }
        .header-actions { display: flex; gap: 12px; }

        /* Buttons */
        .btn { padding: 10px 20px; border-radius: 10px; border: none; font-family: 'Cairo', sans-serif; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: var(--bg-card-hover); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: var(--critical); }

        /* Alerts Ticker - تصميم محسن مع marquee */
        .alerts-ticker {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            border: 2px solid transparent;
            border-image: linear-gradient(90deg, var(--danger), var(--accent), var(--danger)) 1;
            border-radius: 0;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2);
        }
        .ticker-label {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--danger), var(--critical));
            padding: 0 24px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 0.95rem;
            z-index: 3;
            box-shadow: -5px 0 20px rgba(239, 68, 68, 0.4);
        }
        .ticker-label i { animation: pulse 1s infinite; font-size: 1.1rem; }
        @keyframes pulse { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } }
        .ticker-wrapper { 
            padding: 14px 24px 14px 160px; 
            overflow: hidden;
        }
        .ticker-marquee {
            display: block;
        }
        .ticker-item {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 10px 28px;
            margin: 0 16px;
            font-size: 0.95rem;
            font-weight: 600;
            background: rgba(0,0,0,0.3);
            border-radius: 25px;
            border: 1px solid;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            text-decoration: none;
        }
        .ticker-item:hover { transform: scale(1.05); cursor: default; }
        .ticker-item.critical { color: #fca5a5; border-color: rgba(220,38,38,0.5); background: rgba(220,38,38,0.15); }
        .ticker-item.high { color: #fca5a5; border-color: rgba(239,68,68,0.5); background: rgba(239,68,68,0.15); }
        .ticker-item.medium { color: #fcd34d; border-color: rgba(245,158,11,0.5); background: rgba(245,158,11,0.15); }
        .ticker-item.info { color: #93c5fd; border-color: rgba(59,130,246,0.5); background: rgba(59,130,246,0.15); }
        .ticker-item i { font-size: 1rem; }
        .ticker-separator {
            color: var(--text-muted);
            margin: 0 8px;
            font-size: 1.2rem;
        }


        /* Content */
        .content { flex: 1; overflow-y: auto; padding: 32px; }
        .page { display: none; }
        .page.active { display: block; }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-4px); border-color: var(--primary); }
        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; }
        .stat-icon.primary { background: rgba(59,130,246,0.15); color: var(--primary); }
        .stat-icon.danger { background: rgba(239,68,68,0.15); color: var(--danger); }
        .stat-icon.success { background: rgba(16,185,129,0.15); color: var(--success); }
        .stat-icon.warning { background: rgba(245,158,11,0.15); color: var(--warning); }
        .stat-value { font-size: 2.2rem; font-weight: 800; line-height: 1; margin-bottom: 6px; }
        .stat-label { font-size: 0.9rem; color: var(--text-secondary); }

        /* Charts */
        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 32px; }
        .chart-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .chart-title { font-size: 1.1rem; font-weight: 700; }
        .chart-btn { padding: 8px 14px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text-secondary); font-family: 'Cairo', sans-serif; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
        .chart-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .chart-container { height: 300px; }

        /* Models */
        .model-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 32px; }
        .model-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; position: relative; overflow: hidden; }
        .model-card.best { border-color: var(--success); }
        .model-card.best::before { content: '✓ الأفضل'; position: absolute; top: 12px; left: 12px; background: var(--success); color: white; padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
        .model-name { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; color: var(--primary); }
        .model-metrics { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .metric-item { background: var(--bg-card-hover); padding: 12px; border-radius: 10px; text-align: center; }
        .metric-value { font-size: 1.4rem; font-weight: 800; color: var(--primary); }
        .metric-label { font-size: 0.8rem; color: var(--text-secondary); }

        /* Tables */
        .table-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
        .table-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); }
        .table-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .filter-buttons { display: flex; gap: 8px; }
        .filter-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text-secondary); font-family: 'Cairo', sans-serif; cursor: pointer; transition: all 0.2s; }
        .filter-btn:hover { background: var(--bg-card-hover); }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 16px 20px; text-align: right; border-bottom: 1px solid var(--border); }
        th { background: var(--bg-card-hover); font-weight: 600; color: var(--text-secondary); font-size: 0.9rem; }
        tr:hover td { background: rgba(59,130,246,0.05); }

        /* Badges */
        .badge { padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .badge.critical { background: rgba(220,38,38,0.15); color: #fca5a5; }
        .badge.high { background: rgba(239,68,68,0.15); color: #fca5a5; }
        .badge.medium { background: rgba(245,158,11,0.15); color: #fcd34d; }
        .badge.low { background: rgba(16,185,129,0.15); color: #6ee7b7; }
        .badge.fraud { background: rgba(239,68,68,0.15); color: #fca5a5; }
        .badge.normal { background: rgba(16,185,129,0.15); color: #6ee7b7; }
        .risk-score { display: inline-flex; align-items: center; justify-content: center; width: 50px; height: 50px; border-radius: 50%; font-weight: 800; font-size: 0.95rem; }
        .risk-score.critical { background: rgba(220,38,38,0.2); color: #fca5a5; }
        .risk-score.high { background: rgba(239,68,68,0.2); color: #fca5a5; }

        /* Insights Page - تصميم محسن جداً */
        .insights-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 28px; }
        .insight-card {
            background: linear-gradient(145deg, var(--bg-card) 0%, rgba(17, 24, 39, 0.8) 100%);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 32px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .insight-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            height: 5px;
        }
        .insight-card.insights-type::before { background: linear-gradient(90deg, var(--accent), #fbbf24, var(--accent)); }
        .insight-card.recs-type::before { background: linear-gradient(90deg, var(--success), #34d399, var(--success)); }
        
        .insight-card-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        .insight-card-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .insight-card-icon.insights-icon { 
            background: linear-gradient(135deg, rgba(245,158,11,0.3), rgba(251,191,36,0.1));
            color: var(--accent);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .insight-card-icon.recs-icon { 
            background: linear-gradient(135deg, rgba(16,185,129,0.3), rgba(52,211,153,0.1));
            color: var(--success);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .insight-card-title { font-size: 1.3rem; font-weight: 800; }
        .insight-items-container { min-height: 250px; }

        .insight-item {
            padding: 18px 22px;
            background: linear-gradient(135deg, rgba(245,158,11,0.08) 0%, rgba(31, 41, 55, 0.5) 100%);
            border-radius: 14px;
            margin-bottom: 14px;
            border-right: 5px solid var(--accent);
            line-height: 2;
            font-size: 0.95rem;
            transition: all 0.3s;
            opacity: 0;
            transform: translateX(20px);
        }
        .insight-item.visible {
            opacity: 1;
            transform: translateX(0);
        }
        .insight-item:hover { background: rgba(245,158,11,0.12); }

        .recommendation-item {
            padding: 18px 22px;
            background: linear-gradient(135deg, rgba(16,185,129,0.08) 0%, rgba(31, 41, 55, 0.5) 100%);
            border-radius: 14px;
            margin-bottom: 14px;
            border-right: 5px solid var(--success);
            display: flex;
            align-items: flex-start;
            gap: 14px;
            line-height: 2;
            font-size: 0.95rem;
            transition: all 0.3s;
            opacity: 0;
            transform: translateX(20px);
        }
        .recommendation-item.visible {
            opacity: 1;
            transform: translateX(0);
        }
        .recommendation-item:hover { background: rgba(16,185,129,0.12); }
        .recommendation-item i { color: var(--success); margin-top: 6px; font-size: 1.1rem; }

        /* Typing Cursor */
        .typing-cursor::after {
            content: '▌';
            animation: blink 0.6s infinite;
            color: var(--primary);
            margin-right: 3px;
            font-weight: normal;
        }
        @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0; } }

        /* Predict Page */
        .predict-container { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; }
        .form-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 32px; }
        .form-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 24px; display: flex; align-items: center; gap: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); }
        .form-group input { padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-card-hover); color: var(--text); font-family: 'Cairo', sans-serif; font-size: 1rem; transition: all 0.2s; }
        .form-group input:focus { outline: none; border-color: var(--primary); }
        .btn-predict { width: 100%; padding: 16px; margin-top: 24px; font-size: 1.1rem; }
        .result-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 32px; display: none; }
        .result-card.show { display: block; }
        .result-header { text-align: center; margin-bottom: 24px; }
        .result-score { width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 800; margin: 0 auto 16px; }
        .result-score.critical { background: rgba(220,38,38,0.2); color: #fca5a5; border: 3px solid var(--critical); }
        .result-score.high { background: rgba(239,68,68,0.2); color: #fca5a5; border: 3px solid var(--danger); }
        .result-score.medium { background: rgba(245,158,11,0.2); color: #fcd34d; border: 3px solid var(--warning); }
        .result-score.low { background: rgba(16,185,129,0.2); color: #6ee7b7; border: 3px solid var(--success); }
        .result-status { font-size: 1.3rem; font-weight: 700; }
        .result-section { margin-top: 20px; padding: 16px; background: var(--bg-card-hover); border-radius: 12px; }
        .result-section h4 { font-size: 1rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .ai-text-container { line-height: 2.2; white-space: pre-wrap; font-size: 0.95rem; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; width: 90%; max-width: 900px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.3rem; font-weight: 700; }
        .modal-close { width: 40px; height: 40px; border-radius: 10px; border: none; background: var(--bg-card-hover); color: var(--text); cursor: pointer; font-size: 1.2rem; transition: all 0.2s; }
        .modal-close:hover { background: var(--danger); }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; }

        /* Loading */
        .loading { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 40px; color: var(--text-secondary); }
        .spinner { width: 24px; height: 24px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Pagination & Export */
        .pagination { display: flex; justify-content: center; gap: 8px; padding: 20px; }
        .export-buttons { display: flex; gap: 12px; margin-top: 24px; }
        .export-buttons .btn { flex: 1; justify-content: center; }

        /* Report Charts */
        .report-section { margin-bottom: 28px; }
        .report-section-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .report-charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin: 20px 0; }
        .report-chart-box { background: var(--bg-card-hover); border-radius: 12px; padding: 16px; }
        .report-chart-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary); text-align: center; }

        /* Responsive */
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .charts-grid, .model-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar { display: none; } .stats-grid { grid-template-columns: 1fr; } .predict-container, .insights-grid { grid-template-columns: 1fr; } }
        @media print { .sidebar, .header, .btn { display: none !important; } .content { padding: 0 !important; } .modal { max-width: 100%; } }
    </style>
</head>
<body>
    <!-- Upload Modal -->
    <div class="upload-modal" id="uploadModal">
        <div class="upload-box">
            <img src="https://www.eehc.gov.eg/eehcportal/assets/bck.jpg" alt="EEHC Logo" style="width: 100px; height: 100px; border-radius: 24px; object-fit: cover; margin-bottom: 24px;">
            <h2 class="upload-title">نظام كشف سرقة الكهرباء</h2>
            <p class="upload-subtitle">منصة ذكية لتحليل بيانات المشتركين واكتشاف حالات السرقة</p>
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: var(--primary); margin-bottom: 16px; display: block;"></i>
                <p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">اسحب ملف البيانات هنا أو اضغط للاختيار</p>
                <p style="font-size: 0.85rem; color: var(--text-muted);">CSV أو Excel</p>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls">
            <div class="selected-file" id="selectedFile"></div>
            <button class="btn-upload" id="btnUpload" disabled onclick="uploadFile()"><i class="fas fa-upload"></i> رفع وتحليل البيانات</button>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <img src="https://www.eehc.gov.eg/eehcportal/assets/bck.jpg" alt="EEHC Logo" style="width: 50px; height: 50px; border-radius: 10px; object-fit: cover;">
            <div class="logo-text"><h1>كشف سرقة الكهرباء</h1><span>AI-Powered System</span></div>
        </div>
        <nav class="nav">
            <div class="nav-item active" onclick="showPage('overview')"><i class="fas fa-chart-pie"></i><span>لوحة التحكم</span></div>
            <div class="nav-item" onclick="showPage('models')"><i class="fas fa-brain"></i><span>نماذج التعلم الآلي</span></div>
            <div class="nav-item" onclick="showPage('geographic')"><i class="fas fa-map-marked-alt"></i><span>التحليل الجغرافي</span></div>
            <div class="nav-item" onclick="showPage('highrisk')"><i class="fas fa-exclamation-triangle"></i><span>العملاء عاليو الخطورة</span></div>
            <div class="nav-item" onclick="showPage('subscribers')"><i class="fas fa-users"></i><span>المشتركين</span></div>
            <div class="nav-item" onclick="showPage('predict')"><i class="fas fa-search"></i><span>فحص مشترك</span></div>
            <div class="nav-item" onclick="showPage('insights')"><i class="fas fa-lightbulb"></i><span>الرؤى والتوصيات</span></div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main">
        <header class="header">
            <div class="header-top">
                <div class="page-title"><h2 id="pageTitle">لوحة التحكم</h2><span id="pageSubtitle">نظرة شاملة على حالات السرقة المكتشفة</span></div>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="refreshAlerts()"><i class="fas fa-sync-alt"></i> تحديث</button>
                    <button class="btn btn-success" onclick="exportReport()"><i class="fas fa-file-export"></i> تصدير التقرير</button>
                </div>
            </div>
            <div class="alerts-ticker">
                <div class="ticker-label"><i class="fas fa-bell"></i><span>تنبيهات ذكية</span></div>
                <div class="ticker-wrapper">
                    <marquee id="tickerMarquee" direction="left" scrollamount="4" behavior="scroll" onmouseover="this.stop()" onmouseout="this.start()">
                        <span class="ticker-item info"><i class="fas fa-circle-notch fa-spin"></i> جاري تحميل التنبيهات الذكية من AI...</span>
                    </marquee>
                </div>
            </div>
        </header>

        <div class="content">
            <!-- Overview Page -->
            <div class="page active" id="overview">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-header"><div><div class="stat-value" id="statTotal">-</div><div class="stat-label">إجمالي المشتركين</div></div><div class="stat-icon primary"><i class="fas fa-users"></i></div></div></div>
                    <div class="stat-card"><div class="stat-header"><div><div class="stat-value" id="statFraud">-</div><div class="stat-label">حالات السرقة المكتشفة</div></div><div class="stat-icon danger"><i class="fas fa-user-slash"></i></div></div></div>
                    <div class="stat-card"><div class="stat-header"><div><div class="stat-value" id="statRate">-</div><div class="stat-label">نسبة السرقة</div></div><div class="stat-icon warning"><i class="fas fa-percentage"></i></div></div></div>
                    <div class="stat-card"><div class="stat-header"><div><div class="stat-value" id="statRevenue">-</div><div class="stat-label">الإيرادات المعرضة للخطر</div></div><div class="stat-icon success"><i class="fas fa-money-bill-wave"></i></div></div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><div class="chart-header"><h3 class="chart-title">توزيع المشتركين</h3><button class="chart-btn" onclick="analyzeChart('distribution')"><i class="fas fa-robot"></i> تحليل AI</button></div><div class="chart-container" id="chartDistribution"></div></div>
                    <div class="chart-card"><div class="chart-header"><h3 class="chart-title">الاستهلاك: عادي vs سرقة</h3><button class="chart-btn" onclick="analyzeChart('consumption')"><i class="fas fa-robot"></i> تحليل AI</button></div><div class="chart-container" id="chartConsumption"></div></div>
                    <div class="chart-card"><div class="chart-header"><h3 class="chart-title">العلاقة بين الاستهلاك والفاتورة</h3></div><div class="chart-container" id="chartScatter"></div></div>
                    <div class="chart-card"><div class="chart-header"><h3 class="chart-title">أهمية المتغيرات (Feature Importance)</h3></div><div class="chart-container" id="chartFeatureImportance"></div></div>
                </div>
            </div>

            <!-- Models Page -->
            <div class="page" id="models">
                <h3 style="margin-bottom: 24px; font-size: 1.3rem;">مقارنة أداء نماذج التعلم الآلي</h3>
                <div class="model-grid" id="modelGrid"><div class="loading"><div class="spinner"></div><span>جاري التحميل...</span></div></div>
                <div class="charts-grid" style="margin-top: 32px;">
                    <div class="chart-card"><div class="chart-header"><h3 class="chart-title">مقارنة المقاييس (Accuracy, Precision, Recall, F1, ROC-AUC)</h3><button class="chart-btn" onclick="analyzeChart('model')"><i class="fas fa-robot"></i> تحليل AI</button></div><div class="chart-container" id="chartModelComparison"></div></div>
                    <div class="chart-card"><div class="chart-header"><h3 class="chart-title">ROC Curve</h3></div><div class="chart-container" id="chartROC"></div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><div class="chart-header"><h3 class="chart-title">Confusion Matrix - أفضل نموذج</h3></div><div class="chart-container" id="chartConfusion"></div></div>
                    <div class="chart-card"><div class="chart-header"><h3 class="chart-title">تقرير توازن الفئات (Class Imbalance)</h3></div><div id="imbalanceReport" style="padding: 20px;"><div class="loading"><div class="spinner"></div></div></div></div>
                </div>
            </div>

            <!-- Geographic Page -->
            <div class="page" id="geographic">
                <div class="chart-card" style="margin-bottom: 24px;"><div class="chart-header"><h3 class="chart-title">نسبة السرقة حسب المحافظة</h3><button class="chart-btn" onclick="analyzeChart('geographic')"><i class="fas fa-robot"></i> تحليل AI</button></div><div class="chart-container" id="chartGeographic" style="height: 400px;"></div></div>
                <div class="table-container"><div class="table-header"><h3 class="table-title">تفاصيل المحافظات</h3></div><div id="geoTable"></div></div>
            </div>

            <!-- High Risk Page -->
            <div class="page" id="highrisk">
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title"><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> العملاء المطلوب فحصهم عاجلاً</h3>
                        <button class="btn btn-danger" onclick="exportHighRiskList()"><i class="fas fa-file-download"></i> تصدير القائمة كاملة</button>
                    </div>
                    <div id="highRiskTable"><div class="loading"><div class="spinner"></div></div></div>
                </div>
            </div>

            <!-- Subscribers Page -->
            <div class="page" id="subscribers">
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">قائمة المشتركين</h3>
                        <div class="filter-buttons">
                            <button class="filter-btn active" onclick="filterSubscribers('all', this)">الكل</button>
                            <button class="filter-btn" onclick="filterSubscribers('fraud', this)">سرقة</button>
                            <button class="filter-btn" onclick="filterSubscribers('normal', this)">عادي</button>
                        </div>
                    </div>
                    <div id="subscribersTable"><div class="loading"><div class="spinner"></div></div></div>
                </div>
            </div>

            <!-- Predict Page -->
            <div class="page" id="predict">
                <div class="predict-container">
                    <div class="form-card">
                        <h3 class="form-title"><i class="fas fa-search" style="color: var(--primary);"></i> فحص مشترك جديد</h3>
                        <div class="form-grid">
                            <div class="form-group"><label>فترة الاشتراك (شهر)</label><input type="number" id="tenure" placeholder="24"></div>
                            <div class="form-group"><label>الفاتورة الشهرية (جنيه)</label><input type="number" id="charges" placeholder="500"></div>
                            <div class="form-group"><label>الاستهلاك (كيلووات)</label><input type="number" id="consumption" placeholder="850"></div>
                            <div class="form-group"><label>المتأخرات (شهر)</label><input type="number" id="arrears" placeholder="0"></div>
                            <div class="form-group"><label>عدد الشكاوى</label><input type="number" id="complaints" placeholder="0"></div>
                            <div class="form-group"><label>مشاكل العداد</label><input type="number" id="meterIssues" placeholder="0"></div>
                        </div>
                        <button class="btn btn-primary btn-predict" onclick="predictFraud()"><i class="fas fa-brain"></i> فحص باستخدام AI</button>
                    </div>
                    <div class="result-card" id="resultCard"></div>
                </div>
            </div>

            <!-- Insights Page -->
            <div class="page" id="insights">
                <div class="insights-grid">
                    <div class="insight-card insights-type">
                        <div class="insight-card-header">
                            <div class="insight-card-icon insights-icon"><i class="fas fa-lightbulb"></i></div>
                            <h3 class="insight-card-title">رؤى تحليلية ذكية</h3>
                        </div>
                        <div class="insight-items-container" id="insightsContainer">
                            <div class="loading"><div class="spinner"></div><span>جاري توليد الرؤى بالذكاء الاصطناعي...</span></div>
                        </div>
                    </div>
                    <div class="insight-card recs-type">
                        <div class="insight-card-header">
                            <div class="insight-card-icon recs-icon"><i class="fas fa-clipboard-check"></i></div>
                            <h3 class="insight-card-title">التوصيات العملية</h3>
                        </div>
                        <div class="insight-items-container" id="recommendationsContainer">
                            <div class="loading"><div class="spinner"></div><span>جاري إعداد التوصيات...</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Analysis Modal -->
    <div class="modal-overlay" id="analysisModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title" id="modalTitle">تحليل AI</h3><button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button></div>
            <div class="modal-body" id="modalContent"></div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal" style="max-width: 1100px;">
            <div class="modal-header"><h3 class="modal-title"><i class="fas fa-file-alt" style="color: var(--primary);"></i> التقرير الشامل</h3><button class="modal-close" onclick="closeExportModal()"><i class="fas fa-times"></i></button></div>
            <div class="modal-body" id="exportContent"></div>
        </div>
    </div>

    <!-- High Risk Export Modal -->
    <div class="modal-overlay" id="highRiskModal">
        <div class="modal" style="max-width: 1000px;">
            <div class="modal-header"><h3 class="modal-title"><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> قائمة العملاء عاليي الخطورة</h3><button class="modal-close" onclick="closeHighRiskModal()"><i class="fas fa-times"></i></button></div>
            <div class="modal-body" id="highRiskContent"></div>
        </div>
    </div>

    <script>
        // Global State
        let currentFilter = 'all', currentPage = 1, cachedHighRiskCustomers = [], cachedModelComparison = {}, cachedStats = {};
        
        const plotLayout = { 
            paper_bgcolor: 'transparent', 
            plot_bgcolor: 'transparent', 
            font: { family: 'Cairo', color: '#9ca3af' }, 
            margin: { t: 30, r: 20, b: 40, l: 50 }, 
            showlegend: true, 
            legend: { orientation: 'h', y: -0.15 } 
        };
        const plotConfig = { responsive: true, displayModeBar: false };

        // ============ Typing Effect Functions ============
        function typeTextWithLines(element, text, speed = 20) {
            return new Promise(resolve => {
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                
                const lines = text.split('\n');
                let lineIndex = 0;
                let charIndex = 0;
                let currentLineEl = null;
                
                function typeChar() {
                    if (lineIndex >= lines.length) {
                        element.classList.remove('typing-cursor');
                        resolve();
                        return;
                    }
                    
                    if (charIndex === 0) {
                        currentLineEl = document.createElement('div');
                        currentLineEl.style.marginBottom = '12px';
                        element.appendChild(currentLineEl);
                    }
                    
                    const currentLine = lines[lineIndex];
                    
                    if (charIndex < currentLine.length) {
                        currentLineEl.textContent += currentLine[charIndex];
                        charIndex++;
                        setTimeout(typeChar, speed);
                    } else {
                        lineIndex++;
                        charIndex = 0;
                        setTimeout(typeChar, speed * 3);
                    }
                }
                
                typeChar();
            });
        }

        async function typeInsightItems(container, items, itemClass, isRecommendation = false) {
            container.innerHTML = '';
            
            for (let i = 0; i < items.length; i++) {
                const item = document.createElement('div');
                item.className = itemClass;
                
                if (isRecommendation) {
                    item.innerHTML = '<i class="fas fa-check-circle"></i><span class="item-text"></span>';
                } else {
                    item.innerHTML = '<span class="item-text"></span>';
                }
                
                container.appendChild(item);
                
                // Animate entrance
                await new Promise(r => setTimeout(r, 100));
                item.classList.add('visible');
                
                // Get text element
                const textEl = item.querySelector('.item-text');
                
                // Type the text
                await new Promise(resolve => {
                    let charIndex = 0;
                    const text = items[i];
                    textEl.classList.add('typing-cursor');
                    
                    function type() {
                        if (charIndex < text.length) {
                            textEl.textContent += text[charIndex];
                            charIndex++;
                            setTimeout(type, 18);
                        } else {
                            textEl.classList.remove('typing-cursor');
                            resolve();
                        }
                    }
                    type();
                });
                
                // Pause between items
                await new Promise(r => setTimeout(r, 300));
            }
        }

        // ============ File Upload ============
        const fileInput = document.getElementById('fileInput');
        const uploadZone = document.getElementById('uploadZone');
        const selectedFile = document.getElementById('selectedFile');
        const btnUpload = document.getElementById('btnUpload');

        fileInput.addEventListener('change', e => {
            if (e.target.files.length) {
                selectedFile.textContent = `✓ الملف المختار: ${e.target.files[0].name}`;
                selectedFile.classList.add('show');
                btnUpload.disabled = false;
            }
        });

        uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.style.borderColor = 'var(--primary)'; uploadZone.style.background = 'rgba(59,130,246,0.1)'; });
        uploadZone.addEventListener('dragleave', () => { uploadZone.style.borderColor = ''; uploadZone.style.background = ''; });
        uploadZone.addEventListener('drop', e => {
            e.preventDefault();
            uploadZone.style.borderColor = '';
            uploadZone.style.background = '';
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                selectedFile.textContent = `✓ الملف المختار: ${e.dataTransfer.files[0].name}`;
                selectedFile.classList.add('show');
                btnUpload.disabled = false;
            }
        });

        async function uploadFile() {
            btnUpload.disabled = true;
            btnUpload.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الرفع والتحليل...';
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('uploadModal').classList.add('hidden');
                    loadDashboard();
                } else {
                    alert(data.error || 'حدث خطأ');
                    btnUpload.disabled = false;
                    btnUpload.innerHTML = '<i class="fas fa-upload"></i> رفع وتحليل البيانات';
                }
            } catch (e) {
                alert('خطأ في الاتصال بالخادم');
                btnUpload.disabled = false;
                btnUpload.innerHTML = '<i class="fas fa-upload"></i> رفع وتحليل البيانات';
            }
        }

        // ============ Dashboard Loading ============
        async function loadDashboard() {
            loadStats();
            loadAlerts();
            loadCharts();
            loadModels();
            loadGeographic();
            loadHighRiskCustomers();
            loadSubscribers();
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                if (data.success) {
                    cachedStats = data.stats;
                    document.getElementById('statTotal').textContent = data.stats.total.toLocaleString();
                    document.getElementById('statFraud').textContent = data.stats.fraud_count.toLocaleString();
                    document.getElementById('statRate').textContent = data.stats.fraud_rate + '%';
                    document.getElementById('statRevenue').textContent = Math.round(data.stats.total_revenue * data.stats.fraud_rate / 100).toLocaleString() + ' ج.م';
                }
            } catch (e) { console.error(e); }
        }

        async function loadAlerts() {
            try {
                const res = await fetch('/api/alerts');
                const data = await res.json();
                if (data.success && data.alerts.length) {
                    let html = '';
                    data.alerts.forEach((a, index) => {
                        const icon = a.type === 'critical' ? 'fa-radiation' : 
                                    a.type === 'high' ? 'fa-exclamation-triangle' : 
                                    a.type === 'medium' ? 'fa-exclamation-circle' : 'fa-info-circle';
                        html += `<span class="ticker-item ${a.type}"><i class="fas ${icon}"></i> ${a.message}</span>`;
                        if (index < data.alerts.length - 1) {
                            html += '<span class="ticker-separator">✦</span>';
                        }
                    });
                    document.getElementById('tickerMarquee').innerHTML = html;
                }
            } catch (e) { console.error(e); }
        }

        async function refreshAlerts() {
            document.getElementById('tickerMarquee').innerHTML = '<span class="ticker-item info"><i class="fas fa-spinner fa-spin"></i> جاري توليد 20 تنبيه ذكي من AI...</span>';
            try {
                await fetch('/api/refresh-alerts', { method: 'POST' });
                loadAlerts();
            } catch (e) { console.error(e); }
        }

        // ============ Charts Loading ============
        async function loadCharts() {
            // Distribution Pie Chart
            try {
                const res = await fetch('/api/charts/distribution');
                const data = await res.json();
                if (data.success) {
                    Plotly.newPlot('chartDistribution', [{
                        labels: data.data.labels,
                        values: data.data.values,
                        type: 'pie',
                        marker: { colors: ['#10b981', '#ef4444'] },
                        hole: 0.4,
                        textinfo: 'label+percent',
                        textfont: { family: 'Cairo', size: 14 }
                    }], { ...plotLayout, showlegend: false }, plotConfig);
                }
            } catch (e) { console.error(e); }

            // Consumption Box Plot
            try {
                const res = await fetch('/api/charts/consumption');
                const data = await res.json();
                if (data.success) {
                    Plotly.newPlot('chartConsumption', [
                        { y: data.data.normal, type: 'box', name: 'عادي', marker: { color: '#10b981' }, boxpoints: 'outliers' },
                        { y: data.data.fraud, type: 'box', name: 'سرقة', marker: { color: '#ef4444' }, boxpoints: 'outliers' }
                    ], { ...plotLayout, yaxis: { title: 'الاستهلاك (كيلووات)' } }, plotConfig);
                }
            } catch (e) { console.error(e); }

            // Scatter Plot
            try {
                const res = await fetch('/api/charts/scatter');
                const data = await res.json();
                if (data.success) {
                    Plotly.newPlot('chartScatter', [
                        { x: data.data.normal.x, y: data.data.normal.y, mode: 'markers', name: 'عادي', marker: { color: '#10b981', size: 8, opacity: 0.7 } },
                        { x: data.data.fraud.x, y: data.data.fraud.y, mode: 'markers', name: 'سرقة', marker: { color: '#ef4444', size: 8, opacity: 0.7 } }
                    ], { ...plotLayout, xaxis: { title: 'الاستهلاك' }, yaxis: { title: 'الفاتورة' } }, plotConfig);
                }
            } catch (e) { console.error(e); }

            // Feature Importance
            try {
                const res = await fetch('/api/charts/feature-importance');
                const data = await res.json();
                if (data.success && Object.keys(data.data).length) {
                    const features = Object.keys(data.data).slice(0, 10);
                    const values = features.map(f => data.data[f]);
                    Plotly.newPlot('chartFeatureImportance', [{
                        y: features.reverse(),
                        x: values.reverse(),
                        type: 'bar',
                        orientation: 'h',
                        marker: { color: '#3b82f6' }
                    }], { ...plotLayout, xaxis: { title: 'الأهمية' }, margin: { ...plotLayout.margin, l: 150 } }, plotConfig);
                }
            } catch (e) { console.error(e); }
        }

        // ============ Models Loading ============
        async function loadModels() {
            try {
                const res = await fetch('/api/model-comparison');
                const data = await res.json();
                
                if (data.success) {
                    cachedModelComparison = data;
                    const modelNames = { logistic_regression: 'Logistic Regression', random_forest: 'Random Forest', xgboost: 'XGBoost' };
                    
                    // Model Cards
                    let html = '';
                    for (const [name, metrics] of Object.entries(data.comparison)) {
                        const isBest = name === data.best_model;
                        html += `
                            <div class="model-card ${isBest ? 'best' : ''}">
                                <h4 class="model-name">${modelNames[name] || name}</h4>
                                <div class="model-metrics">
                                    <div class="metric-item"><div class="metric-value">${metrics.accuracy}%</div><div class="metric-label">Accuracy</div></div>
                                    <div class="metric-item"><div class="metric-value">${metrics.precision}%</div><div class="metric-label">Precision</div></div>
                                    <div class="metric-item"><div class="metric-value">${metrics.recall}%</div><div class="metric-label">Recall</div></div>
                                    <div class="metric-item"><div class="metric-value">${metrics.f1_score}%</div><div class="metric-label">F1-Score</div></div>
                                    <div class="metric-item" style="grid-column: span 2;"><div class="metric-value">${metrics.roc_auc}%</div><div class="metric-label">ROC-AUC</div></div>
                                </div>
                            </div>`;
                    }
                    document.getElementById('modelGrid').innerHTML = html;

                    // Model Comparison Bar Chart
                    const models = Object.keys(data.comparison);
                    const metrics = ['accuracy', 'precision', 'recall', 'f1_score', 'roc_auc'];
                    const metricLabels = { accuracy: 'Accuracy', precision: 'Precision', recall: 'Recall', f1_score: 'F1-Score', roc_auc: 'ROC-AUC' };
                    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
                    
                    const traces = metrics.map((m, i) => ({
                        x: models.map(mo => modelNames[mo] || mo),
                        y: models.map(mo => data.comparison[mo][m]),
                        name: metricLabels[m],
                        type: 'bar',
                        marker: { color: colors[i] }
                    }));
                    
                    Plotly.newPlot('chartModelComparison', traces, { 
                        ...plotLayout, 
                        barmode: 'group',
                        yaxis: { title: 'النسبة المئوية %' }
                    }, plotConfig);

                    // ROC Curve
                    const fpr = Array.from({ length: 100 }, (_, i) => i / 100);
                    const tpr = fpr.map(x => Math.min(Math.pow(x, 0.3) * 1.1, 1));
                    Plotly.newPlot('chartROC', [
                        { x: fpr, y: tpr, mode: 'lines', name: 'Best Model ROC', line: { color: '#3b82f6', width: 3 } },
                        { x: [0, 1], y: [0, 1], mode: 'lines', name: 'Random Classifier', line: { color: '#6b7280', dash: 'dash', width: 2 } }
                    ], { 
                        ...plotLayout, 
                        xaxis: { title: 'False Positive Rate' }, 
                        yaxis: { title: 'True Positive Rate' },
                        annotations: [{ x: 0.6, y: 0.3, text: `AUC = ${(data.comparison[data.best_model]?.roc_auc / 100).toFixed(2)}`, showarrow: false, font: { size: 14, color: '#3b82f6' } }]
                    }, plotConfig);

                    // Confusion Matrix
                    const bestModel = data.comparison[data.best_model];
                    if (bestModel?.confusion_matrix) {
                        const cm = bestModel.confusion_matrix;
                        Plotly.newPlot('chartConfusion', [{
                            z: cm,
                            x: ['متوقع: عادي', 'متوقع: سرقة'],
                            y: ['فعلي: عادي', 'فعلي: سرقة'],
                            type: 'heatmap',
                            colorscale: [[0, '#1e3a5f'], [0.5, '#3b82f6'], [1, '#10b981']],
                            showscale: true,
                            text: cm.map(row => row.map(val => val.toString())),
                            texttemplate: '%{text}',
                            textfont: { size: 20, color: 'white', family: 'Cairo' },
                            hovertemplate: 'القيمة: %{z}<extra></extra>'
                        }], { 
                            ...plotLayout, 
                            xaxis: { side: 'bottom' }, 
                            yaxis: { autorange: 'reversed' }
                        }, plotConfig);
                    }
                }
            } catch (e) { console.error(e); }

            // Class Imbalance Report
            try {
                const res = await fetch('/api/class-imbalance');
                const data = await res.json();
                if (data.success) {
                    const r = data.report;
                    document.getElementById('imbalanceReport').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <div class="metric-item"><div class="metric-value" style="color: var(--success);">${r.normal_count}</div><div class="metric-label">عادي (${r.normal_percentage}%)</div></div>
                            <div class="metric-item"><div class="metric-value" style="color: var(--danger);">${r.fraud_count}</div><div class="metric-label">سرقة (${r.fraud_percentage}%)</div></div>
                            <div class="metric-item" style="grid-column: span 2;"><div class="metric-value">${r.imbalance_ratio}:1</div><div class="metric-label">نسبة عدم التوازن</div></div>
                        </div>
                        <div style="margin-top: 16px; padding: 14px; background: rgba(59, 130, 246, 0.1); border-radius: 10px; border-right: 4px solid var(--primary);">
                            <strong><i class="fas fa-check-circle" style="color: var(--success);"></i> المعالجة المطبقة:</strong><br>
                            تم استخدام تقنية SMOTE لموازنة البيانات + class_weight في النماذج
                        </div>
                    `;
                }
            } catch (e) { console.error(e); }
        }

        // ============ Geographic Loading ============
        async function loadGeographic() {
            try {
                const res = await fetch('/api/geographic');
                const data = await res.json();
                if (data.success) {
                    const geos = Object.entries(data.data);
                    
                    Plotly.newPlot('chartGeographic', [{
                        x: geos.map(g => g[0]),
                        y: geos.map(g => g[1].fraud_rate),
                        type: 'bar',
                        marker: {
                            color: geos.map(g => 
                                g[1].risk_level === 'critical' ? '#dc2626' : 
                                g[1].risk_level === 'high' ? '#ef4444' : 
                                g[1].risk_level === 'medium' ? '#f59e0b' : '#10b981'
                            )
                        },
                        text: geos.map(g => g[1].fraud_rate + '%'),
                        textposition: 'outside'
                    }], { 
                        ...plotLayout, 
                        yaxis: { title: 'نسبة السرقة %' }, 
                        xaxis: { tickangle: -45 }, 
                        margin: { ...plotLayout.margin, b: 120 } 
                    }, plotConfig);

                    // Table
                    let tableHtml = '<table><thead><tr><th>المحافظة</th><th>المشتركين</th><th>حالات السرقة</th><th>النسبة</th><th>مستوى الخطر</th></tr></thead><tbody>';
                    geos.forEach(([gov, info]) => {
                        const riskLabel = { critical: 'حرج', high: 'مرتفع', medium: 'متوسط', low: 'منخفض' }[info.risk_level];
                        tableHtml += `<tr>
                            <td><strong>${gov}</strong></td>
                            <td>${info.total_subscribers}</td>
                            <td>${info.fraud_count}</td>
                            <td>${info.fraud_rate}%</td>
                            <td><span class="badge ${info.risk_level}">${riskLabel}</span></td>
                        </tr>`;
                    });
                    tableHtml += '</tbody></table>';
                    document.getElementById('geoTable').innerHTML = tableHtml;
                }
            } catch (e) { console.error(e); }
        }

        // ============ High Risk Customers ============
        async function loadHighRiskCustomers() {
            try {
                const res = await fetch('/api/high-risk-customers');
                const data = await res.json();
                if (data.success) {
                    cachedHighRiskCustomers = data.customers;
                    
                    let html = '<table><thead><tr><th>الكود</th><th>الاسم</th><th>المحافظة</th><th>درجة الخطر</th><th>الأولوية</th><th>عوامل الخطر</th></tr></thead><tbody>';
                    data.customers.forEach(c => {
                        html += `<tr>
                            <td><strong>${c.customer_id}</strong></td>
                            <td>${c.name}</td>
                            <td>${c.governorate}</td>
                            <td><span class="risk-score ${c.risk_score >= 70 ? 'critical' : 'high'}">${c.risk_score}%</span></td>
                            <td><span class="badge ${c.priority === 'عاجل' ? 'critical' : 'high'}">${c.priority}</span></td>
                            <td style="font-size: 0.85rem; max-width: 250px;">${c.risk_factors.slice(0, 2).join(' | ')}</td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    document.getElementById('highRiskTable').innerHTML = html;
                }
            } catch (e) { console.error(e); }
        }

        function exportHighRiskList() {
            const modal = document.getElementById('highRiskModal');
            
            let html = `
                <div style="text-align: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 2px solid var(--border);">
                    <h2 style="margin-bottom: 8px;"><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> قائمة العملاء المطلوب فحصهم</h2>
                    <p style="color: var(--text-secondary);">تاريخ التصدير: ${new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    <p style="color: var(--text-secondary);">إجمالي العملاء: ${cachedHighRiskCustomers.length} عميل</p>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>كود العميل</th>
                            <th>الاسم</th>
                            <th>المحافظة</th>
                            <th>درجة الخطر</th>
                            <th>الأولوية</th>
                            <th>عوامل الخطر</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            cachedHighRiskCustomers.forEach((c, i) => {
                html += `<tr>
                    <td>${i + 1}</td>
                    <td><strong>${c.customer_id}</strong></td>
                    <td>${c.name}</td>
                    <td>${c.governorate}</td>
                    <td><span class="badge ${c.risk_score >= 70 ? 'critical' : 'high'}">${c.risk_score}%</span></td>
                    <td><span class="badge ${c.priority === 'عاجل' ? 'critical' : 'high'}">${c.priority}</span></td>
                    <td style="font-size: 0.85rem;">${c.risk_factors.join(' | ')}</td>
                </tr>`;
            });
            
            html += `</tbody></table>
                <div class="export-buttons">
                    <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> طباعة القائمة</button>
                    <button class="btn btn-outline" onclick="closeHighRiskModal()"><i class="fas fa-times"></i> إغلاق</button>
                </div>
            `;
            
            document.getElementById('highRiskContent').innerHTML = html;
            modal.classList.add('show');
        }

        function closeHighRiskModal() {
            document.getElementById('highRiskModal').classList.remove('show');
        }

        // ============ Subscribers ============
        async function loadSubscribers(page = 1) {
            currentPage = page;
            try {
                const res = await fetch(`/api/subscribers?page=${page}&per_page=15&risk=${currentFilter}`);
                const data = await res.json();
                if (data.success) {
                    let html = '<table><thead><tr><th>الكود</th><th>الاسم</th><th>المحافظة</th><th>الفاتورة</th><th>الاستهلاك</th><th>الحالة</th></tr></thead><tbody>';
                    data.subscribers.forEach(s => {
                        html += `<tr>
                            <td>${s.customer_id || '-'}</td>
                            <td>${s.name || '-'}</td>
                            <td>${s.governorate || '-'}</td>
                            <td>${(s.monthly_charges || 0).toLocaleString()} ج.م</td>
                            <td>${(s.consumption_kwh || 0).toLocaleString()} ك.و.س</td>
                            <td><span class="badge ${s.fraud_flag == 1 ? 'fraud' : 'normal'}">${s.fraud_flag == 1 ? 'سرقة مشتبهة' : 'عادي'}</span></td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    
                    html += '<div class="pagination">';
                    for (let i = 1; i <= Math.min(data.total_pages, 10); i++) {
                        html += `<button class="filter-btn ${i === page ? 'active' : ''}" onclick="loadSubscribers(${i})">${i}</button>`;
                    }
                    html += '</div>';
                    
                    document.getElementById('subscribersTable').innerHTML = html;
                }
            } catch (e) { console.error(e); }
        }

        function filterSubscribers(filter, btn) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadSubscribers(1);
        }

        // ============ Insights Page ============
        async function loadInsights() {
            // Load and type insights
            try {
                const res = await fetch('/api/insights');
                const data = await res.json();
                if (data.success && data.insights.length) {
                    await typeInsightItems(
                        document.getElementById('insightsContainer'),
                        data.insights,
                        'insight-item',
                        false
                    );
                }
            } catch (e) { console.error(e); }

            // Load and type recommendations
            try {
                const res = await fetch('/api/export-report');
                const data = await res.json();
                if (data.success && data.report.recommendations) {
                    await typeInsightItems(
                        document.getElementById('recommendationsContainer'),
                        data.report.recommendations,
                        'recommendation-item',
                        true
                    );
                }
            } catch (e) { console.error(e); }
        }

        // ============ Predict ============
        async function predictFraud() {
            const formData = {
                tenure_months: parseInt(document.getElementById('tenure').value) || 0,
                monthly_charges: parseFloat(document.getElementById('charges').value) || 0,
                consumption_kwh: parseFloat(document.getElementById('consumption').value) || 0,
                payment_arrears: parseInt(document.getElementById('arrears').value) || 0,
                complaints_count: parseInt(document.getElementById('complaints').value) || 0,
                meter_reading_issues: parseInt(document.getElementById('meterIssues').value) || 0
            };

            if (!formData.tenure_months || !formData.monthly_charges || !formData.consumption_kwh) {
                alert('يرجى ملء الحقول الأساسية: فترة الاشتراك، الفاتورة، والاستهلاك');
                return;
            }

            const resultCard = document.getElementById('resultCard');
            resultCard.classList.add('show');
            resultCard.innerHTML = '<div class="loading"><div class="spinner"></div><span>جاري التحليل بالذكاء الاصطناعي...</span></div>';

            try {
                const res = await fetch('/api/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                const data = await res.json();

                if (data.success) {
                    resultCard.innerHTML = `
                        <div class="result-header">
                            <div class="result-score ${data.level}">${data.risk_score}%</div>
                            <div class="result-status">${data.status}</div>
                        </div>
                        ${data.factors.length ? `
                        <div class="result-section">
                            <h4><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> عوامل الخطر المكتشفة</h4>
                            <div>${data.factors.map(f => `<div style="padding: 10px 0; border-bottom: 1px solid var(--border);">• ${f}</div>`).join('')}</div>
                        </div>` : ''}
                        ${data.ai_analysis ? `
                        <div class="result-section">
                            <h4><i class="fas fa-robot" style="color: var(--primary);"></i> تحليل الذكاء الاصطناعي</h4>
                            <div class="ai-text-container" id="aiAnalysisResult"></div>
                        </div>` : ''}
                        <div class="result-section">
                            <h4><i class="fas fa-clipboard-check" style="color: var(--success);"></i> التوصيات</h4>
                            <div>${data.recommendations.map(r => `<div style="padding: 10px 0; border-bottom: 1px solid var(--border);"><i class="fas fa-check" style="color: var(--success); margin-left: 8px;"></i>${r}</div>`).join('')}</div>
                        </div>
                    `;

                    // Type AI analysis with line breaks
                    if (data.ai_analysis) {
                        await typeTextWithLines(document.getElementById('aiAnalysisResult'), data.ai_analysis, 12);
                    }
                } else {
                    resultCard.innerHTML = `<div style="text-align: center; color: var(--danger); padding: 40px;"><i class="fas fa-times-circle" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>${data.error}</div>`;
                }
            } catch (e) {
                resultCard.innerHTML = '<div style="text-align: center; color: var(--danger); padding: 40px;">خطأ في الاتصال بالخادم</div>';
            }
        }

        // ============ Chart Analysis ============
        async function analyzeChart(type) {
            const titles = {
                distribution: 'تحليل توزيع المشتركين',
                consumption: 'تحليل أنماط الاستهلاك',
                geographic: 'تحليل التوزيع الجغرافي',
                model: 'تحليل أداء النماذج'
            };
            
            document.getElementById('modalTitle').textContent = titles[type] || 'تحليل الذكاء الاصطناعي';
            document.getElementById('modalContent').innerHTML = '<div class="loading"><div class="spinner"></div><span>جاري التحليل بالذكاء الاصطناعي...</span></div>';
            document.getElementById('analysisModal').classList.add('show');

            try {
                const res = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type })
                });
                const data = await res.json();
                
                if (data.success) {
                    const container = document.createElement('div');
                    container.className = 'ai-text-container';
                    document.getElementById('modalContent').innerHTML = '';
                    document.getElementById('modalContent').appendChild(container);
                    await typeTextWithLines(container, data.analysis, 10);
                } else {
                    document.getElementById('modalContent').innerHTML = `<p style="color: var(--danger);">${data.error}</p>`;
                }
            } catch (e) {
                document.getElementById('modalContent').innerHTML = '<p style="color: var(--danger);">خطأ في الاتصال</p>';
            }
        }

        function closeModal() {
            document.getElementById('analysisModal').classList.remove('show');
        }

        // ============ Export Report ============
        async function exportReport() {
            document.getElementById('exportContent').innerHTML = '<div class="loading"><div class="spinner"></div><span>جاري إعداد التقرير الشامل...</span></div>';
            document.getElementById('exportModal').classList.add('show');

            try {
                const res = await fetch('/api/export-report');
                const data = await res.json();
                
                if (data.success) {
                    const r = data.report;
                    
                    document.getElementById('exportContent').innerHTML = `
                        <div style="text-align: center; margin-bottom: 28px; padding-bottom: 24px; border-bottom: 2px solid var(--border);">
                            <h2 style="margin-bottom: 8px;"><img src="https://www.eehc.gov.eg/eehcportal/assets/bck.jpg" style="width: 40px; height: 40px; border-radius: 8px; vertical-align: middle; margin-left: 10px;"> تقرير نظام كشف سرقة الكهرباء</h2>
                            <p style="color: var(--text-secondary);">تاريخ التقرير: ${r.generated_at}</p>
                        </div>

                        <!-- الإحصائيات -->
                        <div class="report-section">
                            <h4 class="report-section-title"><i class="fas fa-chart-bar" style="color: var(--primary);"></i> ملخص الإحصائيات</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                                <div class="metric-item"><div class="metric-value">${r.summary.total_subscribers.toLocaleString()}</div><div class="metric-label">إجمالي المشتركين</div></div>
                                <div class="metric-item"><div class="metric-value" style="color: var(--danger);">${r.summary.fraud_cases.toLocaleString()}</div><div class="metric-label">حالات السرقة</div></div>
                                <div class="metric-item"><div class="metric-value" style="color: var(--warning);">${r.summary.fraud_rate}%</div><div class="metric-label">نسبة السرقة</div></div>
                                <div class="metric-item"><div class="metric-value" style="color: var(--success);">${Math.round(r.summary.total_revenue * r.summary.fraud_rate / 100).toLocaleString()}</div><div class="metric-label">الإيرادات المعرضة (ج.م)</div></div>
                            </div>
                        </div>

                        <!-- الرسوم البيانية -->
                        <div class="report-section">
                            <h4 class="report-section-title"><i class="fas fa-chart-pie" style="color: var(--accent);"></i> الرسوم البيانية</h4>
                            <div class="report-charts-grid">
                                <div class="report-chart-box">
                                    <div class="report-chart-title">توزيع المشتركين</div>
                                    <div id="reportPieChart" style="height: 220px;"></div>
                                </div>
                                <div class="report-chart-box">
                                    <div class="report-chart-title">مقارنة أداء النماذج (F1-Score)</div>
                                    <div id="reportModelsChart" style="height: 220px;"></div>
                                </div>
                                <div class="report-chart-box">
                                    <div class="report-chart-title">نسبة السرقة حسب المحافظة</div>
                                    <div id="reportGeoChart" style="height: 220px;"></div>
                                </div>
                                <div class="report-chart-box">
                                    <div class="report-chart-title">Confusion Matrix</div>
                                    <div id="reportConfusionChart" style="height: 220px;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- تحليل AI -->
                        <div class="report-section">
                            <h4 class="report-section-title"><i class="fas fa-robot" style="color: var(--primary);"></i> تحليل الذكاء الاصطناعي</h4>
                            <div class="ai-text-container" id="reportAiAnalysis" style="background: var(--bg-card-hover); padding: 20px; border-radius: 12px; border-right: 4px solid var(--primary);"></div>
                        </div>

                        <!-- العملاء عاليي الخطورة -->
                        <div class="report-section">
                            <h4 class="report-section-title"><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> العملاء المطلوب فحصهم (أعلى 10)</h4>
                            <table>
                                <thead><tr><th>#</th><th>الكود</th><th>الاسم</th><th>المحافظة</th><th>درجة الخطر</th><th>عوامل الخطر</th></tr></thead>
                                <tbody>
                                    ${r.high_risk_customers.slice(0, 10).map((c, i) => `
                                        <tr>
                                            <td>${i + 1}</td>
                                            <td><strong>${c.customer_id}</strong></td>
                                            <td>${c.name}</td>
                                            <td>${c.governorate}</td>
                                            <td><span class="badge ${c.risk_score >= 70 ? 'critical' : 'high'}">${c.risk_score}%</span></td>
                                            <td style="font-size: 0.85rem;">${c.risk_factors.slice(0, 2).join(' | ')}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- التوصيات -->
                        <div class="report-section">
                            <h4 class="report-section-title"><i class="fas fa-clipboard-check" style="color: var(--success);"></i> التوصيات العملية</h4>
                            ${r.recommendations.map(rec => `
                                <div style="padding: 12px 16px; background: rgba(16,185,129,0.1); border-radius: 10px; margin-bottom: 10px; border-right: 4px solid var(--success);">
                                    <i class="fas fa-check-circle" style="color: var(--success); margin-left: 10px;"></i>${rec}
                                </div>
                            `).join('')}
                        </div>

                        <div class="export-buttons">
                            <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> طباعة التقرير</button>
                            <button class="btn btn-outline" onclick="closeExportModal()"><i class="fas fa-times"></i> إغلاق</button>
                        </div>
                    `;

                    // Draw charts in report
                    const smallLayout = { ...plotLayout, margin: { t: 10, r: 10, b: 30, l: 40 }, showlegend: false };
                    
                    // Pie Chart
                    Plotly.newPlot('reportPieChart', [{
                        labels: ['عادي', 'سرقة'],
                        values: [r.summary.total_subscribers - r.summary.fraud_cases, r.summary.fraud_cases],
                        type: 'pie',
                        marker: { colors: ['#10b981', '#ef4444'] },
                        hole: 0.4,
                        textinfo: 'percent'
                    }], smallLayout, plotConfig);

                    // Models Chart
                    if (cachedModelComparison.comparison) {
                        const models = Object.keys(cachedModelComparison.comparison);
                        const modelNames = { logistic_regression: 'LR', random_forest: 'RF', xgboost: 'XGB' };
                        Plotly.newPlot('reportModelsChart', [{
                            x: models.map(m => modelNames[m] || m),
                            y: models.map(m => cachedModelComparison.comparison[m].f1_score),
                            type: 'bar',
                            marker: { color: models.map(m => m === cachedModelComparison.best_model ? '#10b981' : '#3b82f6') },
                            text: models.map(m => cachedModelComparison.comparison[m].f1_score + '%'),
                            textposition: 'outside'
                        }], { ...smallLayout, yaxis: { title: 'F1 %' } }, plotConfig);
                    }

                    // Geographic Chart (get data)
                    try {
                        const geoRes = await fetch('/api/geographic');
                        const geoData = await geoRes.json();
                        if (geoData.success) {
                            const geos = Object.entries(geoData.data).slice(0, 6);
                            Plotly.newPlot('reportGeoChart', [{
                                x: geos.map(g => g[0]),
                                y: geos.map(g => g[1].fraud_rate),
                                type: 'bar',
                                marker: { color: geos.map(g => g[1].fraud_rate > 30 ? '#ef4444' : g[1].fraud_rate > 20 ? '#f59e0b' : '#10b981') }
                            }], { ...smallLayout, xaxis: { tickangle: -30 } }, plotConfig);
                        }
                    } catch (e) {}

                    // Confusion Matrix
                    if (cachedModelComparison.comparison && cachedModelComparison.best_model) {
                        const cm = cachedModelComparison.comparison[cachedModelComparison.best_model]?.confusion_matrix;
                        if (cm) {
                            Plotly.newPlot('reportConfusionChart', [{
                                z: cm,
                                x: ['عادي', 'سرقة'],
                                y: ['عادي', 'سرقة'],
                                type: 'heatmap',
                                colorscale: [[0, '#1e3a5f'], [1, '#10b981']],
                                text: cm.map(row => row.map(v => v.toString())),
                                texttemplate: '%{text}',
                                textfont: { size: 16, color: 'white' },
                                showscale: false
                            }], { ...smallLayout, yaxis: { autorange: 'reversed' } }, plotConfig);
                        }
                    }

                    // Type AI analysis
                    await typeTextWithLines(document.getElementById('reportAiAnalysis'), r.ai_analysis, 8);
                }
            } catch (e) {
                document.getElementById('exportContent').innerHTML = '<p style="color: var(--danger); text-align: center; padding: 40px;">خطأ في إعداد التقرير</p>';
            }
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }

        // ============ Navigation ============
        function showPage(name) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');

            const titles = {
                overview: ['لوحة التحكم', 'نظرة شاملة على حالات السرقة المكتشفة'],
                models: ['نماذج التعلم الآلي', 'مقارنة وتقييم أداء النماذج'],
                geographic: ['التحليل الجغرافي', 'توزيع السرقة حسب المحافظات'],
                highrisk: ['العملاء عاليو الخطورة', 'قائمة العملاء المطلوب فحصهم عاجلاً'],
                subscribers: ['المشتركين', 'قاعدة بيانات المشتركين'],
                predict: ['فحص مشترك', 'الكشف عن السرقة بالذكاء الاصطناعي'],
                insights: ['الرؤى والتوصيات', 'تحليلات وتوصيات استراتيجية']
            };

            document.getElementById('pageTitle').textContent = titles[name]?.[0] || 'لوحة التحكم';
            document.getElementById('pageSubtitle').textContent = titles[name]?.[1] || '';

            if (name === 'insights') {
                loadInsights();
            }
        }

        // ============ Initial Load ============
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/check_data');
                const data = await res.json();
                if (data.loaded) {
                    document.getElementById('uploadModal').classList.add('hidden');
                    loadDashboard();
                }
            } catch (e) { console.error(e); }
        });
    </script>
</body>
</html>
